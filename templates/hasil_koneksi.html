<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Koneksi DB_Sekolah</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Times New Roman", serif;
    }

    body {
      background: #f0f0f0;
      padding: 40px;
    }

    .pertama1 {
      background: #ffffff;
      max-width: 1100px;
      margin: auto;
      padding: 40px;
      border: 2px solid #000;
    }

    .pertama1 h2 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 25px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
    }

    .filter-container {
      background: #f8f9fa;
      padding: 15px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      border-radius: 5px;
    }

    .filter-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 150px;
    }

    .filter-group label {
      font-size: 14px;
      font-weight: bold;
    }

    .filter-group select,
    .filter-group input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    button, .btn {
      padding: 8px 16px;
      background: #000;
      color: #fff;
      border: 1px solid #000;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      border-radius: 4px;
      text-align: center;
    }

    button:hover, .btn:hover {
      background: #fff;
      color: #000;
    }

    .btn-secondary {
      background: #6c757d;
      border-color: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      color: #fff;
    }

    .btn-success {
      background: #28a745;
      border-color: #28a745;
    }

    .btn-success:hover {
      background: #218838;
      color: #fff;
    }

    .action-buttons {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }

    table th {
      border: 1px solid #000;
      padding: 8px;
      background: #f5f5f5;
      text-align: center;
      font-weight: bold;
    }

    table td {
      border: 1px solid #000;
      padding: 7px;
      text-align: center;
      vertical-align: middle;
    }

    table td:nth-child(2),
    table td:nth-child(3),
    table td:nth-child(11) {
      text-align: left;
    }

    table td:nth-child(9) {
      font-weight: bold;
    }

    table td a {
      text-decoration: none;
      color: #000;
      font-weight: bold;
      margin: 0 5px;
    }

    table td a:hover {
      text-decoration: underline;
    }

    .action-links {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    .action-links a {
      padding: 3px 8px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 12px;
      min-width: 70px;
      text-align: center;
    }

    .action-links a:hover {
      background: #e9ecef;
    }

    .no-data {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .filter-info {
      background: #e9ecef;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 14px;
    }

    @media print {
      .filter-container, .action-buttons, button, a {
        display: none;
      }

      body {
        padding: 0;
        background: none;
      }

      .pertama1 {
        border: none;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="pertama1">
    <h2>Daftar Nilai</h2>

    <!-- Filter Form -->
    <div class="filter-container">
      <form method="GET" action="{{ url_for('daftar_nilai') }}" class="filter-form">
        <div class="filter-group">
          <label for="kelas">Kelas:</label>
          <select name="kelas" id="kelas">
            <option value="">Semua Kelas</option>
            {% for kelas in kelas_list %}
            <option value="{{ kelas.nama_kelas }}" {% if filter_kelas == kelas.nama_kelas %}selected{% endif %}>
              {{ kelas.nama_kelas }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label for="semester">Semester:</label>
          <select name="semester" id="semester">
            <option value="">Semua Semester</option>
            {% for semester in semester_list %}
            <option value="{{ semester.semester }}" {% if filter_semester == semester.semester|string %}selected{% endif %}>
              Semester {{ semester.semester }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label for="tahun_ajaran">Tahun Ajaran:</label>
          <select name="tahun_ajaran" id="tahun_ajaran">
            <option value="">Semua Tahun</option>
            {% for tahun in tahun_ajaran_list %}
            <option value="{{ tahun.tahun_ajaran }}" {% if filter_tahun_ajaran == tahun.tahun_ajaran %}selected{% endif %}>
              {{ tahun.tahun_ajaran }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-buttons">
          <button type="submit" class="btn-success">Terapkan Filter</button>
          <a href="{{ url_for('daftar_nilai') }}" class="btn btn-secondary">Reset Filter</a>
        </div>
      </form>
    </div>

    <!-- Info Filter Aktif -->
    {% if filter_kelas or filter_semester or filter_tahun_ajaran %}
    <div class="filter-info">
      Filter Aktif: 
      {% if filter_kelas %}Kelas: <strong>{{ filter_kelas }}</strong>{% endif %}
      {% if filter_semester %}{% if filter_kelas %}, {% endif %}Semester: <strong>{{ filter_semester }}</strong>{% endif %}
      {% if filter_tahun_ajaran %}{% if filter_kelas or filter_semester %}, {% endif %}Tahun Ajaran: <strong>{{ filter_tahun_ajaran }}</strong>{% endif %}
    </div>
    {% endif %}

    <div class="action-buttons">
      <a href="{{ url_for('tambah_nilai') }}" class="btn">
        + Tambah Nilai
      </a>
      <a href="/" class="btn btn-secondary">
        Refresh
      </a>
    </div>
      <a href="{{ url_for('cetak_pdf_daftar_nilai', kelas=filter_kelas, semester=filter_semester, tahun_ajaran=filter_tahun_ajaran) }}" 
     class="btn" 
     style="background: #dc3545; border-color: #dc3545;">
    Cetak PDF
  </a>
</div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>NIS</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Mapel</th>
          <th>Tugas</th>
          <th>UTS</th>
          <th>UAS</th>
          <th>Nilai Akhir</th>
          <th>Semester</th>
          <th>Tahun Ajaran</th>
          <th>Deskripsi</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% if siswa %}
          {% for s in siswa %}
          <tr>
            <td>{{ s.id_nilai }}</td>
            <td>{{ s.nis }}</td>
            <td>{{ s.nama_siswa }}</td>
            <td>{{ s.nama_kelas }}</td>
            <td>{{ s.nama_mapel }}</td>
            <td>{{ s.nilai_tugas }}</td>
            <td>{{ s.nilai_uts }}</td>
            <td>{{ s.nilai_uas }}</td>
            <td>{{ s.nilai_akhir }}</td>
            <td>{{ s.semester }}</td>
            <td>{{ s.tahun_ajaran }}</td>
            <td>{{ s.deskripsi[:50] }}{% if s.deskripsi|length > 50 %}...{% endif %}</td>
            <td>
              <div class="action-links">
                <a href="{{ url_for('edit_nilai', id_nilai=s.id_nilai) }}">Edit</a>
                <a href="{{ url_for('delete_nilai', id_nilai=s.id_nilai) }}"
                   onclick="return confirm('Yakin ingin hapus?')">Hapus</a>
                <a href="{{ url_for('cetak_rapor', nis=s.nis) }}" target="_blank">
                  Cetak HTML
                </a>
                <a href="{{ url_for('cetak_pdf_siswa', nis=s.nis) }}">
                  Cetak PDF
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="13" class="no-data">
              Tidak ada data ditemukan. 
              {% if filter_kelas or filter_semester or filter_tahun_ajaran %}
                Coba ubah filter atau <a href="{{ url_for('daftar_nilai') }}">reset filter</a>.
              {% else %}
                <a href="{{ url_for('tambah_nilai') }}">Tambah data</a> untuk memulai.
              {% endif %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    {% if siswa %}
    <div style="margin-top: 15px; text-align: right; font-size: 14px; color: #666;">
      Total Data: <strong>{{ siswa|length }}</strong> nilai ditemukan
    </div>
    {% endif %}
  </div>

  <script>
    // Reset form saat halaman dimuat ulang
    document.addEventListener('DOMContentLoaded', function() {
      // Jika tidak ada parameter filter di URL, reset form
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.has('kelas') && !urlParams.has('semester') && !urlParams.has('tahun_ajaran')) {
        document.getElementById('kelas').value = '';
        document.getElementById('semester').value = '';
        document.getElementById('tahun_ajaran').value = '';
      }
    });
  </script>
</body>
</html>